---
 - name: create render directories
   hosts: localhost
   gather_facts: no
   tags: 
   - configuration 
   tasks:

   - name: create configuration directory
     file:
       path: "{{ playbook_dir }}/{{ item }}"
       state: directory
     with_items: 
       - render
       - templates

 - name: configure devices
   hosts: junos-ssh
   connection: local
   gather_facts: no
   tags: 
   -  configuration
   
   tasks:

   - name: Render BGP configuration for junos devices
     template: 
       src: "{{playbook_dir}}/templates/replacebgp.j2" 
       dest: "{{playbook_dir}}/render/{{ inventory_hostname }}.conf"

   - name: push bgp configuration on devices if ansible version is >= 2.4
     junos_config:
#      provider: "{{ credentials }}"
      src: "{{playbook_dir}}/render/{{ inventory_hostname }}.conf"
      update: merge
      src_format: text
      backup: yes
      comment: enforce desired bgp config from ansible
     when: (ansible_version['major'] == 2 and ansible_version['minor']|int >= 4)

 - name: wait for op states to converge
   hosts: localhost
   gather_facts: no

   tasks:
   - pause: seconds=25

 - name: check op states
   hosts: junos-ssh
   connection: local
   gather_facts: no
   tags: 
   - audit
   roles:
   - Juniper.junos


   tasks:

   - name: Retrieve information from devices running Junos
     junos_get_facts:
      host: "{{ junos_host }}"
#      user: "{{ ADMUSER }}"
#      passwd: "{{ ADMPASS }}"
     register: junos

 - include: pb.check.bgp.underlay.yml
